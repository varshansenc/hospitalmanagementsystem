layui.define(["layer","laytpl","upload"],function(X){var R="3.7.9";var G=layui.$;var f=layui.layer;var Q=layui.laytpl;var ad=layui.device();var c="layui-show",x="layim-this",A=20;var a={};var af=function(){this.v=R;G("body").on("click","*[layim-event]",function(ai){var v=G(this),aj=v.attr("layim-event");z[aj]?z[aj].call(this,v,ai):""})};af.prototype.config=function(v){var ai=[];layui.each(Array(5),function(aj){ai.push(layui.cache.dir+"css/modules/layim/skin/"+(aj+1)+".jpg")});v=v||{};v.skin=v.skin||[];layui.each(v.skin,function(aj,ak){ai.unshift(ak)});v.skin=ai;v=G.extend({isfriend:!0,isgroup:!0,voice:"default.mp3"},v);if(!window.JSON||!window.JSON.parse){return}ac(v);return this};af.prototype.pushChatlog=function(v){return w(v),this};af.prototype.on=function(v,ai){if(typeof ai==="function"){a[v]?a[v].push(ai):a[v]=[ai]}return this};af.prototype.cache=function(){return o};af.prototype.chat=function(v){if(!window.JSON||!window.JSON.parse){return}return I(v),this};af.prototype.setChatMin=function(){return E(),this};af.prototype.setChatStatus=function(aj){var ai=K();if(!ai){return}var v=ai.elem.find(".layim-chat-status");return v.html(aj),this};af.prototype.getMessage=function(v){return H(v),this};af.prototype.notice=function(v){return y(v),this};af.prototype.add=function(v){return k(v),this};af.prototype.setFriendGroup=function(v){return k(v,"setGroup"),this};af.prototype.msgbox=function(v){return m(v),this};af.prototype.addList=function(v){return T(v),this};af.prototype.removeList=function(v){return e(v),this};af.prototype.setFriendStatus=function(aj,v){var ai=G(".layim-friend"+aj);ai[v==="online"?"removeClass":"addClass"]("layim-list-gray")};af.prototype.content=function(v){return layui.data.content(v)};var l=function(v){var ai={friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"};v=v||{};v.item=v.item||("d."+v.type);return["{{# var length = 0; layui.each("+v.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+v.type+'" data-index="{{ '+(v.index||"i")+' }}" class="layim-'+(v.type==="history"?"{{i}}":v.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+(ai[v.type]||"暂无数据")+"</li>","{{# } }}"].join("")};var O=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>','<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon">&#xe605;</i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon">&#xe605;</i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>","</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',l({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',l({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',l({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join("");
var B=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join("");var F=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">',"{{# if(d.base && d.base.face){ }}",'<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# }; }}","{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input onchange="selectFile(this)" type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isCustom){ }}",'<span class="layui-icon layim-tool-custom" title="发送自定义消息" layim-event="media" data-type="custom">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon">&#xe618;</i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon">&#xe618;</i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join("");var ag=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join("");var S=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }}>','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join("");var g='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>';var r=function(v){return v<10?"0"+(v|0):v};layui.data.date=function(v){var ai=new Date(v||new Date());return ai.getFullYear()+"-"+r(ai.getMonth()+1)+"-"+r(ai.getDate())+" "+r(ai.getHours())+":"+r(ai.getMinutes())+":"+r(ai.getSeconds())
};layui.data.content=function(ai){var v=function(aj){return new RegExp("\\n*\\["+(aj||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};ai=(ai||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(aj){var ak=aj.replace(/^face/g,"");return'<img alt="'+ak+'" title="'+ak+'" src="'+p[ak]+'">'}).replace(/img\[([^\s]+?)\]/g,function(aj){return'<img class="layui-layim-photos" src="'+aj.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(al){var aj=(al.match(/file\(([\s\S]+?)\)\[/)||[])[1];var ak=(al.match(/\)\[([\s\S]*?)\]/)||[])[1];if(!aj){return al}return'<a class="layui-layim-file" href="'+aj+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(ak||aj)+"</cite></a>"}).replace(/audio\[([^\s]+?)\]/g,function(aj){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+aj.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/custom\[([^\s]+?)\]/g,function(aj){return'<div class="layui-unselect layui-layim-custom" layim-event="playCustom" data-src="'+aj.replace(/(^custom\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>简历信息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(aj){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+aj.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(al){var aj=(al.match(/a\(([\s\S]+?)\)\[/)||[])[1];var ak=(al.match(/\)\[([\s\S]*?)\]/)||[])[1];if(!aj){return al}return'<a href="'+aj+'" target="_blank">'+(ak||aj)+"</a>"}).replace(v(),"<$1 $2>").replace(v("/"),"</$1>").replace(/\n/g,"<br>");return ai};var t=function(ai,aj,v){ai=ai||{};return G.ajax({url:ai.url,type:ai.type||"get",data:ai.data,dataType:ai.dataType||"json",cache:false,success:function(ak){ak.code==0?aj&&aj(ak.data||{}):f.msg(ak.msg||((v||"Error")+": LAYIM_NOT_GET_DATA"),{time:5000})},error:function(ak,al){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+al)}})};var o={message:{},chat:[]},ac=function(v){var ai=v.init||{};mine=ai.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:v,local:local,mine:mine,history:local.history||{}},create=function(ak){var am=ak.mine||{};var aj=layui.data("layim")[am.id]||{},al={base:v,local:aj,mine:am,friend:ak.friend||[],group:ak.group||[],history:aj.history||{}};o=G.extend(o,al);D(Q(O).render(al));if(aj.close||v.min){s()}layui.each(a.ready,function(an,ao){ao&&ao(al)})};o=G.extend(o,obj);if(v.brief){return layui.each(a.ready,function(aj,ak){ak&&ak(obj)})}ai.url?t(ai,create,"INIT"):create(ai)};var n,D=function(v){return f.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:false,anim:2,resize:false,content:v,success:function(aj){n=aj;ae(aj);if(o.base.right){aj.css("margin-left","-"+o.base.right)}if(q){f.close(q.attr("times"))}var ai=[],ak=aj.find(".layim-list-history");ak.find("li").each(function(){ai.push(G(this).prop("outerHTML"))});if(ai.length>0){ai.reverse();ak.html(ai.join(""))}i();z.sign()},cancel:function(ai){s();var aj=layui.data("layim")[o.mine.id]||{};aj.close=true;layui.data("layim",{key:o.mine.id,value:aj});return false}})};var i=function(){n.on("contextmenu",function(ai){ai.cancelBubble=true;ai.returnValue=false;return false});var v=function(){f.closeAll("tips")};n.find(".layim-list-history").on("contextmenu","li",function(ak){var aj=G(this);var ai='<ul data-id="'+aj[0].id+'" data-index="'+aj.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';if(aj.hasClass("layim-null")){return}f.tips(ai,this,{tips:1,time:0,anim:5,fixed:true,skin:"layui-box layui-layim-contextmenu",success:function(al){var am=function(an){N(an)};al.off("mousedown",am).on("mousedown",am)}});G(document).off("mousedown",v).on("mousedown",v);G(window).off("resize",v).on("resize",v)})};var q,s=function(v){if(q){f.close(q.attr("times"))}if(n){n.hide()}o.mine=o.mine||{};return f.open({type:1,title:false,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:false,closeBtn:false,anim:2,offset:"rb",resize:false,content:'<img src="'+(o.mine.avatar||(layui.cache.dir+"css/pc/layim/skin/logo.jpg"))+'"><span>'+(v||o.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(ai,aj){q=ai;if(o.base.right){ai.css("margin-left","-"+o.base.right)}ai.on("click",function(){f.close(aj);n.show();var ak=layui.data("layim")[o.mine.id]||{};delete ak.close;layui.data("layim",{key:o.mine.id,value:ak})})}})};var aa,W,V,u={},I=function(an){an=an||{};var v=G("#layui-layim-chat"),aj={data:an,base:o.base,local:o.local};if(!an.id){return f.msg("非法用户")
}if(v[0]){var am=aa.find(".layim-chat-list");var ak=am.find(".layim-chatlist-"+an.type+an.id);var ao=aa.find(".layui-layer-max").hasClass("layui-layer-maxmin");var al=v.children(".layim-chat-box");if(aa.css("display")==="none"){aa.show()}if(W){f.close(W.attr("times"))}if(am.find("li").length===1&&!ak[0]){ao||aa.css("width",800);am.css({height:aa.height()}).show();al.css("margin-left","200px")}if(!ak[0]){am.append(Q(g).render(aj));al.append(Q(F).render(aj));ah(an);Z()}Y(am.find(".layim-chatlist-"+an.type+an.id));ak[0]||U();j(an);L();return V}aj.first=!0;var ai=V=f.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:false,maxmin:true,offset:an.offset||"auto",anim:an.anim||0,closeBtn:o.base.brief?false:1,content:Q('<ul class="layui-unselect layim-chat-list">'+g+'</ul><div class="layim-chat-box">'+F+"</div>").render(aj),success:function(ap){aa=ap;ap.css({"min-width":"500px","min-height":"420px"});ah(an);typeof an.success==="function"&&an.success(ap);L();ae(ap);j(an);U();C();layui.each(a.chatChange,function(aq,ar){ar&&ar(K())});ap.on("dblclick",".layui-layim-photos",function(){var aq=this.src;f.close(I.photosIndex);f.photos({photos:{data:[{"alt":"大图模式","src":aq}]},shade:0.01,closeBtn:2,anim:0,resize:false,success:function(ar,at){I.photosIndex=at}})})},full:function(ap){f.style(ai,{width:"100%",height:"100%"},true);Z()},resizing:Z,restore:Z,min:function(){E();return false},end:function(){f.closeAll("tips");aa=null}});return ai};var ah=function(v){G(".layim-"+v.type+v.id).each(function(){if(G(this).hasClass("layim-list-gray")){layui.layim.setFriendStatus(v.id,"offline")}})};var Z=function(){var aj=aa.find(".layim-chat-list"),ai=aa.find(".layim-chat-main"),v=aa.height();aj.css({height:v});ai.css({height:v-20-80-158})};var E=function(ai){var v=ai||K().data,aj=layui.layim.cache().base;if(aa&&!ai){aa.hide()}f.close(E.index);E.index=f.open({type:1,title:false,skin:"layui-box layui-layim-min",shade:false,closeBtn:false,anim:v.anim||2,offset:"b",move:"#layui-layim-min",resize:false,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+v.avatar+'"><span>'+v.name+"</span>",success:function(ak,al){if(!ai){W=ak}if(aj.minRight){f.style(al,{left:G(window).width()-ak.outerWidth()-parseFloat(aj.minRight)})}ak.find(".layui-layer-content span").on("click",function(){f.close(al);ai?layui.each(o.chat,function(am,an){I(an)}):aa.show();if(ai){o.chat=[];J()}});ak.find(".layui-layer-content img").on("click",function(am){N(am)})}})};var k=function(ai,v){ai=ai||{};f.close(k.index);return k.index=f.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[ai.type]||"",shade:false,resize:false,btn:v?["确认","取消"]:["发送申请","关闭"],content:Q(ag).render({data:{name:ai.username||ai.groupname,avatar:ai.avatar,group:ai.group||parent.layui.layim.cache().friend||[],type:ai.type},type:v}),yes:function(al,aj){var ak=aj.find("#LAY_layimGroup"),am=aj.find("#LAY_layimRemark");if(v){ai.submit&&ai.submit(ak.val(),al)}else{ai.submit&&ai.submit(ak.val(),am.val(),al)}}})};var Y=function(al,ai){al=al||G(".layim-chat-list ."+x);var aj=al.index()===-1?0:al.index();var am=".layim-chat",v=aa.find(am).eq(aj);var an=aa.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(ai){if(al.hasClass(x)){Y(aj===0?al.next():al.prev())}var ak=aa.find(am).length;if(ak===1){return f.close(V)}al.remove();v.remove();if(ak===2){aa.find(".layim-chat-list").hide();if(!an){aa.css("width","600px")}aa.find(".layim-chat-box").css("margin-left",0)}return false}al.addClass(x).siblings().removeClass(x);v.addClass(c).siblings(am).removeClass(c);v.find("textarea").focus();layui.each(a.chatChange,function(ao,ap){ap&&ap(K())});C()};var C=function(){var v=K();var ai=o.message[v.data.type+v.data.id];if(ai){delete o.message[v.data.type+v.data.id]}};var K=af.prototype.thisChat=function(){if(!aa){return}var ai=G(".layim-chat-list ."+x).index();var v=aa.find(".layim-chat").eq(ai);var aj=JSON.parse(decodeURIComponent(v.find(".layim-chat-tool").data("json")));return{elem:v,data:aj,textarea:v.find("textarea")}};var ae=function(v){var ai=layui.data("layim")[o.mine.id]||{},aj=ai.skin;v.css({"background-image":aj?"url("+aj+")":function(){return o.base.initSkin?"url("+(layui.cache.dir+"css/modules/layim/skin/"+o.base.initSkin)+")":"none"}()})};var j=function(aj){var v=layui.data("layim")[o.mine.id]||{};var al={},ak=v.history||{};var ai=ak[aj.type+aj.id];if(!n){return}var am=n.find(".layim-list-history");aj.historyTime=new Date().getTime();ak[aj.type+aj.id]=aj;v.history=ak;layui.data("layim",{key:o.mine.id,value:v});if(ai){return}al[aj.type+aj.id]=aj;var an=Q(l({type:"history",item:"d.data"})).render({data:al});am.prepend(an);am.find(".layim-null").remove()};var b=function(){var al={username:o.mine?o.mine.username:"访客",avatar:o.mine?o.mine.avatar:(layui.cache.dir+"css/pc/layim/skin/logo.jpg"),id:o.mine?o.mine.id:null,mine:true};var ai=K(),aj=ai.elem.find(".layim-chat-main ul");var v=o.base.maxLength||3000;al.content=ai.textarea.val();if(al.content.replace(/\s/g,"")!==""){if(al.content.length>v){return f.msg("内容最长不能超过"+v+"个字符")
}aj.append(Q(S).render(al));var am={mine:al,to:ai.data},ak={username:am.mine.username,avatar:am.mine.avatar,id:am.to.id,type:am.to.type,content:am.mine.content,timestamp:new Date().getTime(),mine:true};w(ak);layui.each(a.sendMessage,function(an,ao){ao&&ao(am)})}J();ai.textarea.val("").focus()};var y=function(v){v=v||{};if(window.Notification){if(Notification.permission==="granted"){var ai=new Notification(v.title||"",{body:v.content||"",icon:v.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"})}else{Notification.requestPermission()}}};var P=function(){if(ad.ie&&ad.ie<9){return}var v=document.createElement("audio");v.src=layui.cache.dir+"css/modules/layim/voice/"+o.base.voice;v.play()};var d={},H=function(aj){aj=aj||{};var v=G(".layim-chatlist-"+aj.type+aj.id);var an={},ak=v.index();aj.timestamp=aj.timestamp||new Date().getTime();if(aj.fromid==o.mine.id){aj.mine=true}aj.system||w(aj);d=JSON.parse(JSON.stringify(aj));if(o.base.voice){P()}if((!aa&&aj.content)||ak===-1){if(o.message[aj.type+aj.id]){o.message[aj.type+aj.id].push(aj)}else{o.message[aj.type+aj.id]=[aj];if(aj.type==="friend"){var ai;layui.each(o.friend,function(ar,aq){layui.each(aq.list,function(at,au){if(au.id==aj.id){au.type="friend";au.name=au.username;o.chat.push(au);return ai=true}});if(ai){return true}});if(!ai){aj.name=aj.username;aj.temporary=true;o.chat.push(aj)}}else{if(aj.type==="group"){var ao;layui.each(o.group,function(aq,ar){if(ar.id==aj.id){ar.type="group";ar.name=ar.groupname;o.chat.push(ar);return ao=true}});if(!ao){aj.name=aj.groupname;o.chat.push(aj)}}else{aj.name=aj.name||aj.username||aj.groupname;o.chat.push(aj)}}}if(aj.type==="group"){layui.each(o.group,function(aq,ar){if(ar.id==aj.id){an.avatar=ar.avatar;return true}})}if(!aj.system){if(o.base.notice){y({title:"来自 "+aj.username+" 的消息",content:aj.content,avatar:an.avatar||aj.avatar})}return E({name:"收到新消息",avatar:an.avatar||aj.avatar,anim:6})}}if(!aa){return}var am=K();if(am.data.type+am.data.id!==aj.type+aj.id){v.addClass("layui-anim layer-anim-06");setTimeout(function(){v.removeClass("layui-anim layer-anim-06")},300)}var ap=aa.find(".layim-chat").eq(ak);var al=ap.find(".layim-chat-main ul");if(aj.system){if(ak!==-1){al.append('<li class="layim-chat-system"><span>'+aj.content+"</span></li>")}}else{if(aj.content.replace(/\s/g,"")!==""){al.append(Q(S).render(aj))}}J()};var h="layui-anim-loop layer-anim-05",m=function(v){var ai=n.find(".layim-tool-msgbox");ai.find("span").addClass(h).html(v)};var w=function(ak){var aj=layui.data("layim")[o.mine.id]||{};aj.chatlog=aj.chatlog||{};var v=aj.chatlog[ak.type+ak.id];if(v){var al;layui.each(v,function(am,an){if(an.cid===ak.cid){al=true}else{if((an.timestamp===ak.timestamp&&an.type===ak.type&&an.id===ak.id&&an.content===ak.content&&an.cid===ak.cid)){al=true}}});if(!(al||ak.id==o.mine.id)){var ai=true;layui.each(v,function(am,an){if(ai){if(an.timestamp>ak.timestamp){ai=false;v.splice(am,0,ak)}}});if(ai){v.push(ak)}}if(v.length>A){v.shift()}}else{aj.chatlog[ak.type+ak.id]=[ak]}layui.data("layim",{key:o.mine.id,value:aj})};var U=function(){var aj=layui.data("layim")[o.mine.id]||{},v=K(),ak=aj.chatlog||{},ai=v.elem.find(".layim-chat-main ul");layui.each(ak[v.data.type+v.data.id],function(al,am){ai.append(Q(S).render(am))});J()};var T=function(al){var am={},ai,aj=n.find(".layim-list-"+al.type);if(o[al.type]){if(al.type==="friend"){layui.each(o.friend,function(an,ao){if(al.groupid==ao.id){layui.each(o.friend[an].list,function(ap,aq){if(aq.id==al.id){return ai=true}});if(ai){return f.msg("好友 ["+(al.username||"")+"] 已经存在列表中",{anim:6})}o.friend[an].list=o.friend[an].list||[];am[o.friend[an].list.length]=al;al.groupIndex=an;o.friend[an].list.push(al);return true}})}else{if(al.type==="group"){layui.each(o.group,function(an,ao){if(ao.id==al.id){return ai=true}});if(ai){return f.msg("您已是 ["+(al.groupname||"")+"] 的群成员",{anim:6})}am[o.group.length]=al;o.group.push(al)}}}if(ai){return}var ak=Q(l({type:al.type,item:"d.data",index:al.type==="friend"?"data.groupIndex":null})).render({data:am});if(al.type==="friend"){var v=aj.find(">li").eq(al.groupIndex);v.find(".layui-layim-list").append(ak);v.find(".layim-count").html(o.friend[al.groupIndex].list.length);if(v.find(".layim-null")[0]){v.find(".layim-null").remove()}}else{if(al.type==="group"){aj.append(ak);if(aj.find(".layim-null")[0]){aj.find(".layim-null").remove()}}}};var e=function(ai){var v=n.find(".layim-list-"+ai.type);var aj={};if(o[ai.type]){if(ai.type==="friend"){layui.each(o.friend,function(al,ak){layui.each(ak.list,function(an,ao){if(ai.id==ao.id){var am=v.find(">li").eq(al);var ap=am.find(".layui-layim-list>li");am.find(".layui-layim-list>li").eq(an).remove();o.friend[al].list.splice(an,1);am.find(".layim-count").html(o.friend[al].list.length);if(o.friend[al].list.length===0){am.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>')}return true}})})}else{if(ai.type==="group"){layui.each(o.group,function(ak,al){if(ai.id==al.id){v.find(">li").eq(ak).remove();o.group.splice(ak,1);
if(o.group.length===0){v.html('<li class="layim-null">暂无群组</li>')}return true}})}}}};var J=function(){var v=K(),ak=v.elem.find(".layim-chat-main");var ai=ak.find("ul");var aj=ai.find("li").length;if(aj>=A){var al=ai.find("li").eq(0);if(!ai.prev().hasClass("layim-chat-system")){ai.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>')}if(aj>A){al.remove()}}ak.scrollTop(ak[0].scrollHeight+1000);ak.find("ul li:last").find("img").load(function(){ak.scrollTop(ak[0].scrollHeight+1000)})};var L=function(){var ai=K(),v=ai.textarea;v.focus();v.off("keydown").on("keydown",function(al){var aj=layui.data("layim")[o.mine.id]||{};var ak=al.keyCode;if(aj.sendHotKey==="Ctrl+Enter"){if(al.ctrlKey&&ak===13){b()}return}if(ak===13){if(al.ctrlKey){return v.val(v.val()+"\n")}if(al.shiftKey){return}al.preventDefault();b()}})};var p=function(){var ai=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],v={};layui.each(ai,function(aj,ak){v[ak]=layui.cache.dir+"images/face/"+aj+".gif"});return v}();var N=layui.stope;var ab=function(ai,ak){var v,aj=ai.value;ai.focus();if(document.selection){v=document.selection.createRange();document.selection.empty();v.text=ak}else{if(ak.indexOf("img")>-1){v=[ak]}else{v=[aj.substring(0,ai.selectionStart),ak,aj.substr(ai.selectionEnd)]}ai.focus();ai.value=v.join("")}};var M="layui-anim-upbit",z={status:function(ak,al){var v=function(){ak.next().hide().removeClass(M)};var ai=ak.attr("lay-type");if(ai==="show"){N(al);ak.next().show().addClass(M);G(document).off("click",v).on("click",v)}else{var aj=ak.parent().prev();ak.addClass(x).siblings().removeClass(x);aj.html(ak.find("cite").html());aj.removeClass("layim-status-"+(ai==="online"?"hide":"online")).addClass("layim-status-"+ai);layui.each(a.online,function(am,an){an&&an(ai)})}},sign:function(){var v=n.find(".layui-layim-remark");v.on("change",function(){var ai=this.value;layui.each(a.sign,function(aj,ak){ak&&ak(ai)})});v.on("keyup",function(aj){var ai=aj.keyCode;if(ai===13){this.blur()}})},tab:function(ak){var ai,v=".layim-tab-content";var aj=n.find(".layui-layim-tab>li");typeof ak==="number"?(ai=ak,ak=aj.eq(ai)):(ai=ak.index());ai>2?aj.removeClass(x):(z.tab.index=ai,ak.addClass(x).siblings().removeClass(x));n.find(v).eq(ai).addClass(c).siblings(v).removeClass(c)},spread:function(ak){var aj=ak.attr("lay-type");var ai=aj==="true"?"false":"true";var v=layui.data("layim")[o.mine.id]||{};ak.next()[aj==="true"?"removeClass":"addClass"](c);v["spread"+ak.parent().index()]=ai;layui.data("layim",{key:o.mine.id,value:v});ak.attr("lay-type",ai);ak.find(".layui-icon").html(ai==="true"?"&#xe61a;":"&#xe602;")},search:function(ak){var aj=n.find(".layui-layim-search");var v=n.find("#layui-layim-search");var ai=aj.find("input"),al=function(av){var am=ai.val().replace(/\s/);if(am===""){z.tab(z.tab.index|0)}else{var ar=[],ao=o.friend||[];var aw=o.group||[],au="";for(var at=0;at<ao.length;at++){for(var ap=0;ap<(ao[at].list||[]).length;ap++){if(ao[at].list[ap].username.indexOf(am)!==-1){ao[at].list[ap].type="friend";ao[at].list[ap].index=at;ao[at].list[ap].list=ap;ar.push(ao[at].list[ap])}}}for(var aq=0;aq<aw.length;aq++){if(aw[aq].groupname.indexOf(am)!==-1){aw[aq].type="group";aw[aq].index=aq;aw[aq].list=aq;ar.push(aw[aq])}}if(ar.length>0){for(var an=0;an<ar.length;an++){au+='<li layim-event="chat" data-type="'+ar[an].type+'" data-index="'+ar[an].index+'" data-list="'+ar[an].list+'"><img src="'+ar[an].avatar+'"><span>'+(ar[an].username||ar[an].groupname||"佚名")+"</span><p>"+(ar[an].remark||ar[an].sign||"")+"</p></li>"}}else{au='<li class="layim-null">无搜索结果</li>'}v.html(au);z.tab(3)}};if(!o.base.isfriend&&o.base.isgroup){z.tab.index=1}else{if(!o.base.isfriend&&!o.base.isgroup){z.tab.index=2}}aj.show();ai.focus();ai.off("keyup",al).on("keyup",al)},closeSearch:function(v){v.parent().hide();z.tab(z.tab.index|0)},msgbox:function(){var v=n.find(".layim-tool-msgbox");f.close(z.msgbox.index);v.find("span").removeClass(h).html("");return z.msgbox.index=f.open({type:2,title:"消息盒子",shade:false,maxmin:true,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:false,content:o.base.msgbox})},find:function(){f.close(z.find.index);return z.find.index=f.open({type:2,title:"查找",shade:false,maxmin:true,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:false,content:o.base.find})},skin:function(){f.open({type:1,title:"更换背景",shade:false,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:false,content:Q(B).render({skin:o.base.skin})})},about:function(){f.alert("版本： "+R+"<br>版权所有：安徽软云",{title:"关于 软云IM",shade:false})
},setSkin:function(ai){var ak=ai.attr("src");var v=layui.data("layim")[o.mine.id]||{};v.skin=ak;if(!ak){delete v.skin}layui.data("layim",{key:o.mine.id,value:v});try{n.css({"background-image":ak?"url("+ak+")":"none"});aa.css({"background-image":ak?"url("+ak+")":"none"})}catch(aj){}layui.each(a.setSkin,function(am,an){var al=(ak||"").replace(layui.cache.dir+"css/modules/layim/skin/","");an&&an(al,ak)})},chat:function(am){var ai=layui.data("layim")[o.mine.id]||{};var aj=am.data("type"),v=am.data("index");var al=am.attr("data-list")||am.index(),ak={};if(aj==="friend"){ak=o[aj][v].list[al]}else{if(aj==="group"){ak=o[aj][al]}else{if(aj==="history"){ak=(ai.history||{})[v]||{}}}}ak.name=ak.name||ak.username||ak.groupname;if(aj!=="history"){ak.type=aj}I(ak)},tabChat:function(v){Y(v)},closeChat:function(v,ai){Y(v.parent(),1);N(ai)},closeThisChat:function(){Y(null,1)},groupMembers:function(ak,al){var ai=ak.find(".layui-icon"),v=function(){ai.html("&#xe61a;");ak.data("down",null);f.close(z.groupMembers.index)},aj=function(am){N(am)};if(ak.data("down")){v()}else{ai.html("&#xe619;");ak.data("down",true);z.groupMembers.index=f.tips('<ul class="layim-members-list"></ul>',ak,{tips:3,time:0,anim:5,fixed:true,skin:"layui-box layui-layim-members",success:function(an){var ao=o.base.members||{},ap=K(),ar=an.find(".layim-members-list"),am="",at={},au=aa.find(".layui-layer-max").hasClass("layui-layer-maxmin"),aq=aa.find(".layim-chat-list").css("display")==="none";if(au){ar.css({width:G(window).width()-22-(aq||200)})}ao.data=G.extend(ao.data,{id:ap.data.id});t(ao,function(av){layui.each(av.list,function(aw,ax){am+='<li data-uid="'+ax.id+'"><a href="javascript:;"><img src="'+ax.avatar+'"><cite>'+ax.username+"</cite></a></li>";at[ax.id]=ax});ar.html(am);ak.find(".layim-chat-members").html(av.members||(av.list||[]).length+"人");ar.find("li").on("click",function(){var aw=G(this).data("uid"),ax=at[aw];I({name:ax.username,type:"friend",avatar:ax.avatar,id:ax.id});v()});layui.each(a.members,function(aw,ax){ax&&ax(av)})});an.on("mousedown",function(av){N(av)})}});G(document).off("mousedown",v).on("mousedown",v);G(window).off("resize",v).on("resize",v);ak.off("mousedown",aj).on("mousedown",aj)}},send:function(){b()},setSend:function(ak,al){var aj=z.setSend.box=ak.siblings(".layim-menu-box"),ai=ak.attr("lay-type");if(ai==="show"){N(al);aj.show().addClass(M);G(document).off("click",z.setSendHide).on("click",z.setSendHide)}else{ak.addClass(x).siblings().removeClass(x);var v=layui.data("layim")[o.mine.id]||{};v.sendHotKey=ai;layui.data("layim",{key:o.mine.id,value:v});z.setSendHide(al,ak.parent())}},setSendHide:function(ai,v){(v||z.setSend.box).hide().removeClass(M)},face:function(ak,al){var aj="",v=K();for(var ai in p){aj+='<li title="'+ai+'"><img src="'+p[ai]+'"></li>'}aj='<ul class="layui-clear layim-face-list">'+aj+"</ul>";z.face.index=f.tips(aj,ak,{tips:1,time:0,fixed:true,skin:"layui-box layui-layim-face",success:function(am){am.find(".layim-face-list>li").on("mousedown",function(an){N(an)}).on("click",function(){ab(v.textarea[0],"face"+this.title+" ");f.close(z.face.index)})}});G(document).off("mousedown",z.faceHide).on("mousedown",z.faceHide);G(window).off("resize",z.faceHide).on("resize",z.faceHide);N(al)},faceHide:function(){f.close(z.face.index)},image:function(al){file=al.find("input")[0];var ak=al.data("type")||"images",aj={images:"uploadImage",file:"uploadFile"},ai=K(),v=o.base[aj[ak]]||{};layui.upload.render({url:v.url||"",method:v.type,elem:al.find("input")[0],accept:ak,done:function(am){if(am.code==0){am.data=am.data||{};if(ak==="images"){ab(ai.textarea[0],"img["+(am.data.src||"")+"]")}else{if(ak==="file"){ab(ai.textarea[0],"file("+(am.data.src||"")+")["+(am.data.name||"下载文件")+"]")}}b()}else{f.msg(am.msg||"上传失败")}}})},media:function(aj){var ai=aj.data("type"),ak={audio:"音频",video:"视频"},v=K();f.prompt({title:"请输入网络"+ak[ai]+"地址",shade:false,offset:[aj.offset().top-G(window).scrollTop()-158+"px",aj.offset().left+"px"]},function(am,al){ab(v.textarea[0],ai+"["+am+"]");b();f.close(al)})},extend:function(aj){var ai=aj.attr("lay-filter"),v=K();layui.each(a["tool("+ai+")"],function(ak,al){al&&al.call(aj,function(am){ab(v.textarea[0],am)},b,v)})},playAudio:function(aj){var v=aj.data("audio"),ai=v||document.createElement("audio"),ak=function(){ai.pause();aj.removeAttr("status");aj.find("i").html("&#xe652;")};if(aj.data("error")){return f.msg("播放音频源异常")}if(!ai.play){return f.msg("您的浏览器不支持audio")}if(aj.attr("status")){ak()}else{v||(ai.src=aj.data("src"));ai.play();aj.attr("status","pause");aj.data("audio",ai);aj.find("i").html("&#xe651;");ai.onended=function(){ak()};ai.onerror=function(){f.msg("播放音频源异常");aj.data("error",true);ak()}}},playVideo:function(aj){var ai=aj.data("src"),v=document.createElement("video");if(!v.play){return f.msg("您的浏览器不支持video")}f.close(z.playVideo.index);z.playVideo.index=f.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:true,shade:false,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+ai+'" loop="loop" autoplay="autoplay"></video></div>'})
},chatLog:function(ai){var v=K();if(!o.base.chatLog){return f.msg("未开启更多聊天记录")}f.close(z.chatLog.index);return z.chatLog.index=f.open({type:2,maxmin:true,title:"与 "+v.data.name+" 的聊天记录",area:["450px","100%"],shade:false,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:o.base.chatLog+"?id="+v.data.id+"&type="+v.data.type})},menuHistory:function(am,ao){var aj=layui.data("layim")[o.mine.id]||{};var al=am.parent(),ak=am.data("type");var ai=n.find(".layim-list-history");var v='<li class="layim-null">暂无历史会话</li>';if(ak==="one"){var an=aj.history;delete an[al.data("index")];aj.history=an;layui.data("layim",{key:o.mine.id,value:aj});G("#"+al.data("id")).remove();if(ai.find("li").length===0){ai.html(v)}}else{if(ak==="all"){delete aj.history;layui.data("layim",{key:o.mine.id,value:aj});ai.html(v)}}f.closeAll("tips")}};X("layim",new af())}).addcss("modules/layim/layim.css?v=3.7.9","skinlayimcss");